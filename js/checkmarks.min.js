var fcn_checkmarks,fcn_userCheckmarksTimeout;function fcn_initializeCheckmarks(){fcn_checkmarks=fcn_getCheckmarks(),fcn_fetchCheckmarksFromDatabase(),_$$("button.checkmark").forEach((a=>{a.addEventListener("click",(a=>{fcn_clickCheckmark(a.currentTarget)}))}))}function fcn_getCheckmarks(){let a=localStorage.getItem("fcnCheckmarks");return a=a&&fcn_isValidJSONString(a)?JSON.parse(a):{lastLoaded:0,data:{},timestamp:Date.now()},a.data&&!a["last-loaded"]||(a={lastLoaded:0,data:{}}),a}function fcn_toggleCheckmark(a,c,e=null,t=null,n="toggle"){if(!fcn_checkmarks)return;let s=fcn_getCheckmarks();if(localStorage.removeItem("fcnBookshelfContent"),fcn_checkmarks.data.hasOwnProperty(a)||(fcn_checkmarks.data[a]=[]),s.data.hasOwnProperty(a)||(s.data[a]=[]),"toggle"===n&&JSON.stringify(s.data[a])!==JSON.stringify(fcn_checkmarks.data[a]))return fcn_checkmarks=s,fcn_showNotification(__("Checkmarks re-synchronized.","fictioneer")),void fcn_updateCheckmarksView();if(fcn_checkmarks=s,e&&"progress"===c&&!fcn_checkmarks.data[a].includes(e)&&fcn_checkmarks.data[a].push(e),e&&"chapter"===c&&(!fcn_checkmarks.data[a].includes(e)&&"unset"!==n||"set"===n?(fcn_checkmarks.data[a].push(e),t&&t.classList.add("marked")):(fcn_removeItemOnce(fcn_checkmarks.data[a],e),t&&t.classList.remove("marked"),fcn_removeItemOnce(fcn_checkmarks.data[a],a),_$("button[data-type=story]")?.classList.remove("marked"))),"story"===c){let c=(fcn_checkmarks.data[a].includes(a)||"unset"===n)&&"set"!==n;fcn_checkmarks.data[a]=[],c||(_$$("button.checkmark").forEach((c=>{fcn_checkmarks.data[a].push(parseInt(c.dataset.id))})),fcn_checkmarks.data[a].includes(a)||fcn_checkmarks.data[a].push(a))}fcn_checkmarks.data[a]=fcn_checkmarks.data[a].filter(((a,c,e)=>e.indexOf(a)==c)),fcn_checkmarks.lastLoaded=0,fcn_updateCheckmarksView();let r={action:"fictioneer_ajax_set_checkmark",story_id:a,update:fcn_checkmarks.data[a].join(" ")};clearTimeout(fcn_userCheckmarksTimeout),fcn_userCheckmarksTimeout=setTimeout((()=>{fcn_ajaxPost(r).then((a=>{a.data.error&&fcn_showNotification(a.data.error,3,"warning")})).catch((a=>{a.status&&a.statusText&&fcn_showNotification(`${a.status}: ${a.statusText}`,5,"warning")}))}),fictioneer_ajax.post_debounce_rate)}function fcn_clickCheckmark(a){fcn_toggleCheckmark(parseInt(a.dataset.storyId),a.dataset.type,parseInt(a.dataset.id),a)}function fcn_updateCheckmarksView(){if(!fcn_checkmarks)return;let a=parseInt(fcn_inlineStorage.storyId),c=fcn_checkmarks.data.hasOwnProperty(a),e=c&&fcn_checkmarks.data[a].includes(a);c||(fcn_checkmarks.data[a]=[]),e&&_$$("button.checkmark").forEach((c=>{let e=parseInt(c.dataset.id);fcn_checkmarks.data[a].includes(e)||fcn_checkmarks.data[a].push(e)})),_$$$("ribbon-read")?.classList.toggle("hidden",!e),_$$("button.checkmark")?.forEach((a=>{let c=parseInt(a.dataset.storyId);fcn_checkmarks.data.hasOwnProperty(c)&&a.classList.toggle("marked",fcn_checkmarks.data[c].includes(parseInt(a.dataset.id)))})),_$$(".card-checkmark-icon")?.forEach((a=>{let c=parseInt(a.dataset.storyId),e=fcn_checkmarks.data.hasOwnProperty(c)&&(fcn_checkmarks.data[c].includes(parseInt(a.dataset.checkId))||fcn_checkmarks.data[c].includes(c));a.toggleAttribute("hidden",!e)})),localStorage.setItem("fcnCheckmarks",JSON.stringify(fcn_checkmarks))}function fcn_fetchCheckmarksFromDatabase(){fcn_isLoggedIn&&(fcn_ajaxLimitThreshold<fcn_checkmarks.lastLoaded?fcn_updateCheckmarksView():fcn_ajaxGet({action:"fictioneer_ajax_get_checkmarks"}).then((a=>{if(a.success){let c=a.data.checkmarks;c=fcn_isValidJSONString(c)?c:"{}",c=JSON.parse(c),(fcn_checkmarks="object"==typeof c&&c.data&&Object.keys(c.data).length>0?c:{data:{},timestamp:Date.now()}).lastLoaded=Date.now()}})).catch((()=>{localStorage.removeItem("fcnCheckmarks"),fcn_checkmarks=!1})).then((()=>{fcn_updateCheckmarksView(),localStorage.removeItem("fcnBookshelfContent")})))}fcn_isLoggedIn&&fcn_initializeCheckmarks();